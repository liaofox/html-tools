<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡½æ•°å›¾åƒæŸ¥çœ‹å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .graph-canvas {
            width: 100%;
            height: 500px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .close-btn {
            padding: 10px 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 18px;
        }
        .function-info {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <button class="close-btn" onclick="window.close()">Ã— å…³é—­</button>
    <div class="container">
        <div class="graph-header">
            <h1>ğŸ“ˆ å‡½æ•°å›¾åƒ</h1>
        </div>
        
        <div class="function-info">
            <div id="function-expression">æ­£åœ¨åŠ è½½å‡½æ•°è¡¨è¾¾å¼...</div>
        </div>
        
        <div class="graph-canvas">
            <canvas id="graph-canvas"></canvas>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
            <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <p>â€¢ å›¾åƒæ˜¾ç¤ºå‡½æ•°åœ¨ x = [-10, 10] èŒƒå›´å†…çš„å€¼</p>
            <p>â€¢ æ”¯æŒå¸¸è§æ•°å­¦å‡½æ•°ï¼šsin(x), cos(x), x^2, log(x) ç­‰</p>
            <p>â€¢ ä½¿ç”¨é¼ æ ‡æ»šè½®å¯ä»¥ç¼©æ”¾å›¾åƒ</p>
        </div>
    </div>

<script>
        // ä»URLå‚æ•°è·å–å‡½æ•°è¡¨è¾¾å¼
        const urlParams = new URLSearchParams(window.location.search);
        const functionExpr = urlParams.get('function') || 'sin(x)';
        const angleMode = urlParams.get('angleMode') || 'degrees';
        
        document.getElementById('function-expression').textContent = `å‡½æ•°ï¼š${functionExpr} (${angleMode === 'degrees' ? 'è§’åº¦æ¨¡å¼' : 'å¼§åº¦æ¨¡å¼'})`;
        
        // åˆå§‹åŒ–å›¾è¡¨
        const ctx = document.getElementById('graph-canvas').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: functionExpr,
                    data: [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    showLine: true,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'center',
                        min: -20,
                        max: 20,
                        title: {
                            display: true,
                            text: 'x'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'y'
                        }
                    }
                }
            }
        });
        
            // ç”Ÿæˆç”¨äº eval çš„è¡¨è¾¾å¼ï¼ˆä¸è®¡ç®—å™¨ä¸€è‡´çš„å¤„ç†ï¼‰
            function preprocessForEval(expr, mode) {
                let s = expr;
                s = s.replace(/Ï€/g, 'Math.PI').replace(/\bpi\b/g, 'Math.PI').replace(/e/g, 'Math.E').replace(/\^/g, '**');

                if (mode === 'degrees') {
                    s = s.replace(/asin\(([^)]+)\)/g, '(Math.asin($1) * 180 / Math.PI)')
                         .replace(/acos\(([^)]+)\)/g, '(Math.acos($1) * 180 / Math.PI)')
                         .replace(/atan\(([^)]+)\)/g, '(Math.atan($1) * 180 / Math.PI)')
                         .replace(/acot\(([^)]+)\)/g, '(Math.atan(1/($1)) * 180 / Math.PI)');
                    s = s.replace(/sin\(([^)]+)\)/g, 'Math.sin(($1) * Math.PI / 180)')
                         .replace(/cos\(([^)]+)\)/g, 'Math.cos(($1) * Math.PI / 180)')
                         .replace(/tan\(([^)]+)\)/g, 'Math.tan(($1) * Math.PI / 180)')
                         .replace(/cot\(([^)]+)\)/g, '(1/Math.tan(($1) * Math.PI / 180))')
                         .replace(/sec\(([^)]+)\)/g, '(1/Math.cos(($1) * Math.PI / 180))')
                         .replace(/csc\(([^)]+)\)/g, '(1/Math.sin(($1) * Math.PI / 180))');
                } else {
                    s = s.replace(/asin\(([^)]+)\)/g, 'Math.asin($1)')
                         .replace(/acos\(([^)]+)\)/g, 'Math.acos($1)')
                         .replace(/atan\(([^)]+)\)/g, 'Math.atan($1)')
                         .replace(/acot\(([^)]+)\)/g, 'Math.atan(1/($1))');
                    s = s.replace(/sin\(([^)]+)\)/g, 'Math.sin($1)')
                         .replace(/cos\(([^)]+)\)/g, 'Math.cos($1)')
                         .replace(/tan\(([^)]+)\)/g, 'Math.tan($1)')
                         .replace(/cot\(([^)]+)\)/g, '(1/Math.tan($1))')
                         .replace(/sec\(([^)]+)\)/g, '(1/Math.cos($1))')
                         .replace(/csc\(([^)]+)\)/g, '(1/Math.sin($1))');
                }
                s = s.replace(/\blog\(/g, 'Math.log10(')
                     .replace(/\bln\(/g, 'Math.log(')
                     .replace(/\bsqrt\(/g, 'Math.sqrt(')
                     .replace(/\bexp\(/g, 'Math.exp(');

                return s;
            }

            // ç»˜åˆ¶å‡½æ•°å›¾åƒ - æ™ºèƒ½åæ ‡è½´è°ƒæ•´
            function plotFunction() {
                const xValues = [];
                const yValues = [];
                let step = 0.1;
                let yMin = Infinity;
                let yMax = -Infinity;
                
                // æ™ºèƒ½ç¡®å®šxè½´èŒƒå›´
                let xRange = 20; // é»˜è®¤èŒƒå›´
                
                // æ ¹æ®å‡½æ•°ç±»å‹åŠ¨æ€è°ƒæ•´xè½´èŒƒå›´
                if (functionExpr.includes('log') || functionExpr.includes('sqrt')) {
                    xRange = 10; // å¯¹æ•°å‡½æ•°å’Œå¹³æ–¹æ ¹å‡½æ•°èŒƒå›´å°ä¸€äº›
                } else if (functionExpr.match(/\b(sin|cos|tan)\b/)) {
                    xRange = angleMode === 'degrees' ? 720 : 4 * Math.PI; // ä¸‰è§’å‡½æ•°ï¼šåº¦æ¨¡å¼720åº¦ï¼Œå¼§åº¦æ¨¡å¼4Ï€
                } else if (functionExpr.includes('^') || functionExpr.includes('**')) {
                    xRange = 5; // å¹‚å‡½æ•°èŒƒå›´å°ä¸€äº›
                }
                
                const xMin = -Math.abs(xRange);
                const xMax = Math.abs(xRange);
                step = (xMax - xMin) / 1000;
                
                for (let xv = xMin; xv <= xMax; xv += step) {
                    try {
                        // åªæ›¿æ¢ç‹¬ç«‹å˜é‡ xï¼ˆä½¿ç”¨å•è¯è¾¹ç•Œï¼Œé¿å…æ›¿æ¢åˆ° exp ç­‰å‡½æ•°åï¼‰
                        let expr = functionExpr.replace(/\bx\b/gi, `(${xv})`);
                        
                        // é¢„å¤„ç†è¡¨è¾¾å¼ï¼ˆå¸¸æ•°/å‡½æ•°æ˜ å°„ï¼Œè§’åº¦å¤„ç†ï¼‰
                        expr = preprocessForEval(expr, angleMode);
                        
                        const y = eval(expr);
                        
                        if (typeof y === 'number' && isFinite(y)) {
                            xValues.push(xv);
                            yValues.push(y);
                            
                            if (y < yMin) yMin = y;
                            if (y > yMax) yMax = y;
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                // æ™ºèƒ½è°ƒæ•´yè½´èŒƒå›´
                let finalYMin, finalYMax;
                
                if (yMin === Infinity || yMax === -Infinity) {
                    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ•°æ®ç‚¹ï¼Œä½¿ç”¨é»˜è®¤èŒƒå›´
                    finalYMin = -10;
                    finalYMax = 10;
                } else if (Math.abs(yMax - yMin) < 0.001) {
                    // å¦‚æœyå€¼èŒƒå›´éå¸¸å°ï¼ˆå¸¸æ•°å‡½æ•°ï¼‰
                    finalYMin = yMin - 1;
                    finalYMax = yMax + 1;
                } else {
                    // è®¡ç®—åˆç†çš„yè½´èŒƒå›´
                    const yRange = yMax - yMin;
                    const padding = yRange * 0.2; // 20%çš„padding
                    finalYMin = yMin - padding;
                    finalYMax = yMax + padding;
                }
                
                // ç¡®ä¿yè½´èŒƒå›´ä¸ä¼šå¤ªå¤§
                if (Math.abs(finalYMax - finalYMin) > 1000) {
                    finalYMin = -100;
                    finalYMax = 100;
                }
                
                // æ›´æ–°å›¾è¡¨æ•°æ®å’ŒèŒƒå›´
                chart.data.datasets[0].data = xValues.map((x, i) => ({x, y: yValues[i]}));
                chart.data.datasets[0].label = functionExpr;
                chart.options.scales.x.min = xMin;
                chart.options.scales.x.max = xMax;
                chart.options.scales.y.min = finalYMin;
                chart.options.scales.y.max = finalYMax;
                chart.update();
            }
        
            // é¡µé¢åŠ è½½æ—¶ç»˜åˆ¶
            setTimeout(plotFunction, 100);
            
            // ä¿®å¤è§’åº¦æ¨¡å¼å¤„ç†ï¼ˆä¸è®¡ç®—å™¨ä¸€è‡´ï¼‰
            function convertAngleMode(expr, mode) {
                let s = expr;
                // å¸¸æ•°ä¸å¹‚
                s = s.replace(/Ï€/g, 'Math.PI').replace(/\bpi\b/g, 'Math.PI').replace(/e/g, 'Math.E').replace(/\^/g, '**');

                // åä¸‰è§’ -> åœ¨degä¸‹æŠŠç»“æœè½¬æ¢ä¸ºåº¦
                if (mode === 'degrees') {
                    s = s.replace(/asin\(([^)]+)\)/g, '(Math.asin($1) * 180 / Math.PI)')
                         .replace(/acos\(([^)]+)\)/g, '(Math.acos($1) * 180 / Math.PI)')
                         .replace(/atan\(([^)]+)\)/g, '(Math.atan($1) * 180 / Math.PI)')
                         .replace(/acot\(([^)]+)\)/g, '(Math.atan(1/($1)) * 180 / Math.PI)');

                    // æ­£ä¸‰è§’å‚æ•°è½¬å¼§åº¦
                    s = s.replace(/sin\(([^)]+)\)/g, 'Math.sin(($1) * Math.PI / 180)')
                         .replace(/cos\(([^)]+)\)/g, 'Math.cos(($1) * Math.PI / 180)')
                         .replace(/tan\(([^)]+)\)/g, 'Math.tan(($1) * Math.PI / 180)')
                         .replace(/cot\(([^)]+)\)/g, '(1/Math.tan(($1) * Math.PI / 180))')
                         .replace(/sec\(([^)]+)\)/g, '(1/Math.cos(($1) * Math.PI / 180))')
                         .replace(/csc\(([^)]+)\)/g, '(1/Math.sin(($1) * Math.PI / 180))');
                } else {
                    // radians
                    s = s.replace(/asin\(([^)]+)\)/g, 'Math.asin($1)')
                         .replace(/acos\(([^)]+)\)/g, 'Math.acos($1)')
                         .replace(/atan\(([^)]+)\)/g, 'Math.atan($1)')
                         .replace(/acot\(([^)]+)\)/g, 'Math.atan(1/($1))');

                    s = s.replace(/sin\(([^)]+)\)/g, 'Math.sin($1)')
                         .replace(/cos\(([^)]+)\)/g, 'Math.cos($1)')
                         .replace(/tan\(([^)]+)\)/g, 'Math.tan($1)')
                         .replace(/cot\(([^)]+)\)/g, '(1/Math.tan($1))')
                         .replace(/sec\(([^)]+)\)/g, '(1/Math.cos($1))')
                         .replace(/csc\(([^)]+)\)/g, '(1/Math.sin($1))');
                }

                // å¯¹æ•°/æ ¹ç­‰
                s = s.replace(/log\(/g, 'Math.log10(')
                     .replace(/ln\(/g, 'Math.log(')
                     .replace(/sqrt\(/g, 'Math.sqrt(')
                     .replace(/exp\(/g, 'Math.exp(');

                return s;
            }
    </script>
</body>
</html>